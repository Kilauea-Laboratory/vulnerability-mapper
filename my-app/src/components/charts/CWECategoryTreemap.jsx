import React from 'react';
import { ResponsiveTreeMap } from '@nivo/treemap';

const CWECategoryTreemap = ({ data }) => {
  // Flatten CWE categories from the data and convert to numbers
  const cweCategories = data.reduce((categories, vulnerability) => {
    // Extract numbers from the CWEs field and convert to integers
    const numericCWEs = vulnerability.CWEs.match(/\d+/g).map(Number);
    return [...categories, ...numericCWEs];
  }, []);

  // Calculate counts for each CWE category
  const cweCounts = cweCategories.reduce((acc, cwe) => {
    acc[cwe] = (acc[cwe] || 0) + 1;
    return acc;
  }, {});

  // Convert counts to hierarchical data expected by Nivo treemap
  const formattedData = Object.entries(cweCounts).map(([id, count]) => ({
    name: `CWE-${id}`,
    loc: count,
  }));

  return (
    <div style={{ height: '400px', width: '600px' }}>
      <ResponsiveTreeMap
        data={{
          name: 'root',
          children: formattedData,
        }}
        identity="name"
        value="loc"
        valueFormat=".0f"
        margin={{ top: 10, right: 10, bottom: 10, left: 10 }}
        labelSkipSize={12}
        labelTextColor={{
          from: 'color',
          modifiers: [['darker', 1.2]],
        }}
        parentLabelPosition="left"
        parentLabelTextColor={{
          from: 'color',
          modifiers: [['darker', 2]],
        }}
        borderColor={{
          from: 'color',
          modifiers: [['darker', 0.1]],
        }}
      />
    </div>
  );
};

export default CWECategoryTreemap;
