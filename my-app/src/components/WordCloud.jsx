import React, { useEffect } from 'react';
import * as d3 from 'd3';
import d3Cloud from 'd3-cloud';

const WordCloud = ({
  text,
  size = group => group.length,
  word = d => d,
  marginTop = 0,
  marginRight = 0,
  marginBottom = 0,
  marginLeft = 0,
  width = 640,
  height = 400,
  maxWords = 250,
  fontFamily = "sans-serif",
  fontScale = 15,
  padding = 0,
  rotate = 0,
  invalidation
} = {}) => {
  const words = typeof text === "string" ? text.split(/\W+/sg) : Array.from(text);


  const data = d3.rollups(words, size, w => w)
    .sort(([, a], [, b]) => d3.descending(a, b))
    .slice(0, maxWords)
    .map(([key, size]) => ({ text: word(key), size }));

  useEffect(() => {
    const svg = d3.create("svg")
      .attr("viewBox", [0, 0, width, height])
      .attr("width", width)
      .attr("font-family", fontFamily)
      .attr("text-anchor", "middle")
      .attr("style", "max-width: 100%; height: auto; height: intrinsic;");

    const g = svg.append("g").attr("transform", `translate(${marginLeft},${marginTop})`);

    const cloud = d3Cloud()
      .size([width - marginLeft - marginRight, height - marginTop - marginBottom])
      .words(data)
      .padding(padding)
      .rotate(rotate)
      .font(fontFamily)
      .fontSize(d => Math.sqrt(d.size) * fontScale)
      .on("word", ({ size, x, y, rotate, text }) => {
        g.append("text")
          .attr("font-size", size)
          .attr("transform", `translate(${x},${y}) rotate(${rotate})`)
          .text(text);
      });

    cloud.start();
    invalidation && invalidation.then(() => cloud.stop());

    document.getElementById('word-cloud-container').appendChild(svg.node());
  }, [data, fontFamily, fontScale, height, invalidation, marginLeft, marginRight, marginTop, padding, rotate, width]);

  return <div id="word-cloud-container" style={{ width: '100%', height: '100%' }}></div>;
};

const stopwords = new Set([
    "i", "me", "my", "myself", "we", "us", "our", "ours", "ourselves",
    // ... add more stopwords here ...
  ]);


// Example usage
const sourceText = "Hello, World! This is a small cloud for your enjoyment";
const cleanedWords = sourceText
  .split(/[\s.]+/g)
  .map(w => w.replace(/^[“‘"\-—()\[\]{}]+/g, ""))
  .map(w => w.replace(/[;:.!?()\[\]{},"'’”\-—]+$/g, ""))
  .map(w => w.replace(/['’]s$/g, ""))
  .map(w => w.substring(0, 30))
  .map(w => w.toLowerCase())
  .filter(w => w && !stopwords.has(w));

const filteredWords = cleanedWords.filter(w => /\W/.test(w));

// Usage of WordCloud component
const WordCloudExample = () => {
  return (
    <WordCloud
      text={filteredWords}
      width={250}
      height={100}
      size={() => 0.3 + Math.random()}
      rotate={() => (~~(Math.random() * 6) - 3) * 30}
    />
  );
};

export default WordCloud;
