import { useState } from "react";
import dynamic from "next/dynamic";
import { styled, useTheme } from "@mui/material/styles";
import {
  Select,
  Box,
  Grid,
  Paper,
  OutlinedInput,
  InputLabel,
  MenuItem,
  FormControl,
  Slider,
  Chip,
  Divider,
  TextField,
} from "@mui/material";
import { CheckCircleIcon, XMarkIcon } from "@heroicons/react/24/solid";
import data from "../data/nvd.json";
import "../app/globals.css";
import NGrams from "@/components/charts/NGrams";

const BaseScoreBar = dynamic(() => import("@/components/charts/BaseScoreBar"), {
  ssr: false,
});

const ExploitabilityScoreBar = dynamic(
  () => import("@/components/charts/ExploitabilityScoreBar"),
  {
    ssr: false,
  }
);

const ImpactScoreBar = dynamic(
  () => import("@/components/charts/ImpactScoreBar"),
  {
    ssr: false,
  }
);

const CVSSImpactRadar = dynamic(
  () => import("@/components/charts/CVSSImpactRadar"),
  {
    ssr: false,
  }
);

const CVSSExploitabilityRadar = dynamic(
  () => import("@/components/charts/CVSSExploitabilityRadar"),
  {
    ssr: false,
  }
);

const AttackVectorPie = dynamic(
  () => import("@/components/charts/AttackVectorPie"),
  {
    ssr: false,
  }
);

const CWECategoryTreemap = dynamic(
  () => import("@/components/charts/CWECategoryTreemap"),
  {
    ssr: false,
  }
);

const ITEM_HEIGHT = 40;
const ITEM_PADDING_TOP = 4;
const MenuProps = {
  PaperProps: {
    style: {
      maxHeight: ITEM_HEIGHT * 4.5 + ITEM_PADDING_TOP,
      width: 750,
    },
  },
};

const CWENames = [
  "CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
  "CWE-352:	Cross-Site Request Forgery (CSRF)",
  "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
  "CWE-120: Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')",
  "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer",
  "CWE-787: Out-of-bounds Write",
];

const cweLabels = {
  79: "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
  352: "Cross-Site Request Forgery (CSRF)",
  89: "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
  120: "Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')",
  119: "Improper Restriction of Operations within the Bounds of a Memory Buffer",
  787: "Out-of-bounds Write",
};

const formatCWELabel = (cwe) => {
  const cweNumber = parseInt(cwe.replace(/\D/g, ""), 10);
  return `CWE-${cweNumber}: ${cweLabels[cweNumber] || "Unknown"}`;
};

function getStyles(name, CVEsCategory, theme) {
  return {
    fontWeight:
      CVEsCategory.indexOf(name) === -1
        ? theme.typography.fontWeightRegular
        : theme.typography.fontWeightMedium,
  };
}

const attackVectorNames = ["N", "A", "L"];

const attackVectorLabels = {
  N: "Network",
  A: "Adjacent",
  L: "Local",
};

const formatAttackVectorLabel = (av) => {
  return `${attackVectorLabels[av] || "Unknown"}`;
};

const Item = styled(Paper)(({ theme }) => ({
  backgroundColor: theme.palette.mode === "dark" ? "#1A2027" : "#fff",
  ...theme.typography.body2,
  padding: theme.spacing(1),
  textAlign: "center",
  color: theme.palette.text.secondary,
}));

const Visualizer = () => {
  const theme = useTheme();
  const [scoreRange, setScoreRange] = useState([0, 10]);
  const [CVEsCategory, setCVEsCategory] = useState([]);
  const [attackVector, setAttackVector] = useState([]);
  const [CVEs, setCVEs] = useState([]);

  const [inputText, setInputText] = useState("");
  const [prediction, setPrediction] = useState([]);

  const handleClear = () => {
    setInputText("");
    setPrediction([]);
  };

  const handlePrediction = async () => {
    const response = await fetch("/api/predict", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ text: inputText }),
    });

    const data = await response.json();
    const roundedPredictions = data.prediction[0].map((value) =>
      parseFloat(value.toFixed(2))
    );
    setPrediction(roundedPredictions);
  };

  const handleChangeCWE = (event) => {
    const {
      target: { value },
    } = event;

    if (value.includes("none")) {
      setCVEsCategory([]);
      setCVEs(data);
      return;
    }

    const filteredData = data.filter((entry) => {
      const trimmedCWEs = entry.CWEs.trim();
      if (trimmedCWEs !== "") {
        const cweMatches = trimmedCWEs.match(/\d+/g);
        const cweNumbers = cweMatches ? cweMatches.map(Number) : [];
        return cweNumbers.some((cwe) => value.includes(`${cwe}`));
      }
      return false;
    });

    setCVEsCategory(value);
    setCVEs(filteredData);
  };

  const handleChangeAttackVector = (event) => {
    const {
      target: { value },
    } = event;

    if (value.includes("none")) {
      setAttackVector("");
      setCVEs(data);
      return;
    }

    const filteredData = data.filter((entry) => entry.AV === value);

    setAttackVector(value);
    setCVEs(filteredData);
  };

  const handleBaseScore = (event, newValue) => {
    setCVEsCategory([]);
    setAttackVector("");
    setScoreRange(newValue);

    const filtered = data.filter(
      (entry) =>
        entry["Base Score"] >= newValue[0] && entry["Base Score"] <= newValue[1]
    );
    setCVEs(filtered);
  };

  const CVEsToUse = CVEs.length > 0 ? CVEs : data;

  return (
    <main className="flex min-h-screen flex-col items-center justify-between absolute inset-0 bg-gradient-to-t from-[#b05f1300] via-[#b05f1300] to-[#b05f1330]">
      <Box className="shadow p-10" sx={{ width: "100%" }}>
        <Chip
          className="p-6 text-xl text-center font-mono text-[#F36200] bg-white"
          label="Predict Mitigation Strategy"
          variant="outlined"
          sx={{ borderRadius: 1 }}
        />

        <TextField
          id="outlined-multiline-static"
          label="Enter text here to be predicted..."
          value={inputText}
          onChange={(e) => setInputText(e.target.value)}
          multiline
          fullWidth
          rows={3}
        />
        <button
          className="bg-green-600 shadow-lg mt-2 p-3 text-white text-lg"
          onClick={handlePrediction}
        >
          Predict
        </button>
        <button
          className="bg-red-600 ml-2 mt-2 shadow-lg p-3 text-white text-lg"
          onClick={handleClear}
        >
          Clear
        </button>

        {prediction.length > 0 && (
            <Item className="mt-2 mb-4">
              <p className="text-green-600 font-semibold text-lg font-mono">
                Probabilities:
              </p>
              <ul style={{ display: "flex", alignItems: "center" }}>
                {prediction[0] > 0.5 ? (
                  <CheckCircleIcon className="w-4 h-4 mr-2 text-green-600" />
                ) : (
                  <XMarkIcon className="w-4 h-4 mr-2 text-red-600" />
                )}
                ASLR: {prediction[0]}
              </ul>
              <ul style={{ display: "flex", alignItems: "center" }}>
                {prediction[1] > 0.5 ? (
                  <CheckCircleIcon className="w-4 h-4 mr-2 text-green-600" />
                ) : (
                  <XMarkIcon className="w-4 h-4 mr-2 text-red-600" />
                )}
                HPKP/HSTS: {prediction[1]}
              </ul>
              <ul style={{ display: "flex", alignItems: "center" }}>
                {prediction[2] > 0.5 ? (
                  <CheckCircleIcon className="w-4 h-4 mr-2 text-green-600" />
                ) : (
                  <XMarkIcon className="w-4 h-4 mr-2 text-red-600" />
                )}
                MFA: {prediction[2]}
              </ul>
              <ul style={{ display: "flex", alignItems: "center" }}>
                {prediction[3] > 0.5 ? (
                  <CheckCircleIcon className="w-4 h-4 mr-2 text-green-600" />
                ) : (
                  <XMarkIcon className="w-4 h-4 mr-2 text-red-600" />
                )}
                Physical Security: {prediction[3]}
              </ul>
              <ul style={{ display: "flex", alignItems: "center" }}>
                {prediction[4] > 0.5 ? (
                  <CheckCircleIcon className="w-4 h-4 mr-2 text-green-600" />
                ) : (
                  <XMarkIcon className="w-4 h-4 mr-2 text-red-600" />
                )}
                Sandbox: {prediction[4]}
              </ul>
              <ul>Accuracy Score = 0.85</ul>
              <ul>F1 Score (Micro) = 0.90</ul>
              <ul>F1 Score (Macro) = 0.89</ul>

              <p className="font-semibold text-green-600 text-md font-mono mt-4">Common N-grams:</p>
              <ul>
                ('access', 95), ('device', 59), ('attacker', 58), ('physical',
                58)
              </ul>

              <Item className="mt-6">
                <NGrams />
              </Item>
            </Item>
        )}

        <Divider>
          <Chip
            className="p-6 text-2xl font-mono text-[#F36200] bg-white"
            label="Vulnerability Insights"
            variant="outlined"
            sx={{ borderRadius: 0 }}
          />
        </Divider>

        <FormControl sx={{ width: 360 }} className="mb-4 mt-4 mr-6">
          <InputLabel id="multiple-name-label">CWE Category</InputLabel>
          <Select
            labelId="multiple-name-label"
            id="multiple-name"
            multiple
            value={CVEsCategory}
            onChange={handleChangeCWE}
            input={
              <OutlinedInput
                label="CWE Category"
                sx={{ border: "px solid #F36200" }}
              />
            }
            MenuProps={MenuProps}
            className="bg-white"
          >
            <MenuItem
              value="none"
              style={getStyles("none", CVEsCategory, theme)}
            >
              None
            </MenuItem>
            {CWENames.map((name) => (
              <MenuItem
                key={name}
                value={name.match(/\d+/)[0]}
                style={getStyles(name, CVEsCategory, theme)}
              >
                {formatCWELabel(name)}
              </MenuItem>
            ))}
          </Select>
        </FormControl>

        <FormControl sx={{ width: 160 }} className="mb-4 mt-4">
          <InputLabel id="attack-vector-label">Attack Vector</InputLabel>
          <Select
            labelId="attack-vector-label"
            id="attack-vector"
            value={attackVector}
            onChange={handleChangeAttackVector}
            input={<OutlinedInput label="Attack Vector" />}
            className="bg-white"
          >
            <MenuItem
              value="none"
              style={getStyles("none", attackVector, theme)}
            >
              None
            </MenuItem>
            {attackVectorNames.map((av) => (
              <MenuItem
                key={av}
                value={av}
                style={getStyles(av, attackVector, theme)}
              >
                {formatAttackVectorLabel(av)}
              </MenuItem>
            ))}
          </Select>
        </FormControl>

        <Grid container spacing={6}>
          <Grid item xs>
            <Item className="mb-8">
              <h4 className="text-lg text-[#F36200] text-center font-mono">
                Attack Vector
              </h4>
              <AttackVectorPie data={CVEsToUse} />
            </Item>
            <Item>
              <h4 className="text-lg text-[#F36200] text-center font-mono">
                CWE Categories
              </h4>
              <CWECategoryTreemap data={CVEsToUse} />
            </Item>
          </Grid>
          <Grid item xs>
            <Item className="mb-1">
              <h4 className="text-lg text-[#F36200] text-center font-mono">
                Impact Metrics
              </h4>
              <CVSSImpactRadar data={CVEsToUse} />
              <CVSSExploitabilityRadar data={CVEsToUse} />
            </Item>
          </Grid>

          <Grid item xs={4}>
            <Item className="mb-1">
              <h4 className="text-lg text-[#F36200] text-center font-mono">
                Base Scores
              </h4>

              <Box sx={{ width: 200, marginLeft: 21 }}>
                <h4 className="text-md text-[#F36200] text-center font-mono">
                  Range
                </h4>
                <Slider
                  getAriaLabel={() => "Base Score range"}
                  value={scoreRange}
                  onChange={handleBaseScore}
                  marks
                  size="small"
                  valueLabelDisplay="on"
                  style={{ color: "#d1793d", width: "100%" }}
                  min={0}
                  max={10}
                />
              </Box>
              <BaseScoreBar data={CVEsToUse} />
              <ExploitabilityScoreBar data={CVEsToUse} />
              <ImpactScoreBar data={CVEsToUse} />
            </Item>
          </Grid>
        </Grid>
      </Box>
    </main>
  );
};

export default Visualizer;
