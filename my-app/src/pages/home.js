import { useState } from "react";
import dynamic from "next/dynamic";
import { styled, useTheme } from "@mui/material/styles";
import {
  Select,
  Box,
  Grid,
  Paper,
  OutlinedInput,
  InputLabel,
  MenuItem,
  FormControl,
  Slider,
} from "@mui/material";
import data from "../data/nvd.json";
import "../app/globals.css";

const BaseScoreBar = dynamic(() => import("@/components/charts/BaseScoreBar"), {
  ssr: false,
});

const ExploitabilityScoreBar = dynamic(
  () => import("@/components/charts/ExploitabilityScoreBar"),
  {
    ssr: false,
  }
);

const ImpactScoreBar = dynamic(
  () => import("@/components/charts/ImpactScoreBar"),
  {
    ssr: false,
  }
);

const CVSSImpactRadar = dynamic(
  () => import("@/components/charts/CVSSImpactRadar"),
  {
    ssr: false,
  }
);

const CVSSExploitabilityRadar = dynamic(
  () => import("@/components/charts/CVSSExploitabilityRadar"),
  {
    ssr: false,
  }
);

const AttackVectorPie = dynamic(
  () => import("@/components/charts/AttackVectorPie"),
  {
    ssr: false,
  }
);

const CWECategoryTreemap = dynamic(
  () => import("@/components/charts/CWECategoryTreemap"),
  {
    ssr: false,
  }
);

const ParallelCoordinates = dynamic(
  () => import("@/components/charts/ParallelCoordinates"),
  {
    ssr: false,
  }
);

const ITEM_HEIGHT = 40;
const ITEM_PADDING_TOP = 4;
const MenuProps = {
  PaperProps: {
    style: {
      maxHeight: ITEM_HEIGHT * 4.5 + ITEM_PADDING_TOP,
      width: 750,
    },
  },
};

const CWENames = [
  "CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
  "CWE-352:	Cross-Site Request Forgery (CSRF)",
  "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
  "CWE-120: Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')",
  "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer",
  "CWE-787: Out-of-bounds Write",
];

const cweLabels = {
  79: "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
  352: "Cross-Site Request Forgery (CSRF)",
  89: "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
  120: "Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')",
  119: "Improper Restriction of Operations within the Bounds of a Memory Buffer",
  787: "Out-of-bounds Write",
};

const formatCWELabel = (cwe) => {
  const cweNumber = parseInt(cwe.replace(/\D/g, ""), 10);
  return `CWE-${cweNumber}: ${cweLabels[cweNumber] || "Unknown"}`;
};

function getStyles(name, CVEsCategory, theme) {
  return {
    fontWeight:
      CVEsCategory.indexOf(name) === -1
        ? theme.typography.fontWeightRegular
        : theme.typography.fontWeightMedium,
  };
}

const attackVectorNames = ["N", "A", "L"];

const attackVectorLabels = {
  N: "Network",
  A: "Adjacent",
  L: "Local",
};

const formatAttackVectorLabel = (av) => {
  return `${attackVectorLabels[av] || "Unknown"}`;
};

const Item = styled(Paper)(({ theme }) => ({
  backgroundColor: theme.palette.mode === "dark" ? "#1A2027" : "#fff",
  ...theme.typography.body2,
  padding: theme.spacing(1),
  textAlign: "center",
  color: theme.palette.text.secondary,
}));

const Visualizer = () => {
  const theme = useTheme();
  const [scoreRange, setScoreRange] = useState([0, 10]);
  const [CVEsCategory, setCVEsCategory] = useState([]);
  const [attackVector, setAttackVector] = useState([]);
  const [CVEs, setCVEs] = useState([]);

  const [inputText, setInputText] = useState("");
  const [prediction, setPrediction] = useState([]);

  const handlePrediction = async () => {
    const response = await fetch("/api/predict", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ text: inputText }),
    });

    const data = await response.json();
    console.log("data", data);
    setPrediction(data.prediction[0]);
  };


  const handleChangeCWE = (event) => {
    const {
      target: { value },
    } = event;

    if (value.includes("none")) {
      setCVEsCategory([]);
      setCVEs(data);
      return;
    }

    const filteredData = data.filter((entry) => {
      const trimmedCWEs = entry.CWEs.trim();
      if (trimmedCWEs !== "") {
        const cweMatches = trimmedCWEs.match(/\d+/g);
        const cweNumbers = cweMatches ? cweMatches.map(Number) : [];
        return cweNumbers.some((cwe) => value.includes(`${cwe}`));
      }
      return false;
    });

    setCVEsCategory(value);
    setCVEs(filteredData);
  };

  const handleChangeAttackVector = (event) => {
    const {
      target: { value },
    } = event;

    if (value.includes("none")) {
      setAttackVector("");
      setCVEs(data);
      return;
    }

    const filteredData = data.filter((entry) => entry.AV === value);

    setAttackVector(value);
    setCVEs(filteredData);
  };

  const handleBaseScore = (event, newValue) => {
    setCVEsCategory([]);
    setAttackVector("");
    setScoreRange(newValue);

    const filtered = data.filter(
      (entry) =>
        entry["Base Score"] >= newValue[0] && entry["Base Score"] <= newValue[1]
    );
    setCVEs(filtered);
  };

  const CVEsToUse = CVEs.length > 0 ? CVEs : data;

  return (
    <main className="flex min-h-screen flex-col items-center justify-between">
      <Box className="shadow p-4" sx={{ width: "100%" }}>
        <FormControl sx={{ width: 520 }}>
          <InputLabel id="multiple-name-label">CWE Category</InputLabel>
          <Select
            labelId="multiple-name-label"
            id="multiple-name"
            multiple
            value={CVEsCategory}
            onChange={handleChangeCWE}
            input={<OutlinedInput label="CWE Category" />}
            MenuProps={MenuProps}
          >
            <MenuItem
              value="none"
              style={getStyles("none", CVEsCategory, theme)}
            >
              None
            </MenuItem>
            {CWENames.map((name) => (
              <MenuItem
                key={name}
                value={name.match(/\d+/)[0]}
                style={getStyles(name, CVEsCategory, theme)}
              >
                {formatCWELabel(name)}
              </MenuItem>
            ))}
          </Select>
        </FormControl>

        <FormControl sx={{ width: 160 }}>
          <InputLabel id="attack-vector-label">Attack Vector</InputLabel>
          <Select
            labelId="attack-vector-label"
            id="attack-vector"
            value={attackVector}
            onChange={handleChangeAttackVector}
            input={<OutlinedInput label="Attack Vector" />}
          >
            <MenuItem
              value="none"
              style={getStyles("none", attackVector, theme)}
            >
              None
            </MenuItem>
            {attackVectorNames.map((av) => (
              <MenuItem
                key={av}
                value={av}
                style={getStyles(av, attackVector, theme)}
              >
                {formatAttackVectorLabel(av)}
              </MenuItem>
            ))}
          </Select>
        </FormControl>

        <Grid container justifyContent="flex-end" spacing={1}>
          <Grid item>
            <Box sx={{ width: 200, marginRight: 14 }}>
              <h4 className="text-md text-[#F36200] font-semibold text-center font-mono">
                Range
              </h4>
              <Slider
                getAriaLabel={() => "Base Score range"}
                value={scoreRange}
                onChange={handleBaseScore}
                marks
                size="small"
                valueLabelDisplay="on"
                style={{ color: "#F36200", width: "100%" }}
                min={0}
                max={10}
              />
            </Box>
          </Grid>
        </Grid>
        <Grid container spacing={1}>
          <Grid item xs>
            <h4 className="text-lg text-[#F36200] font-semibold text-center font-mono">
              Attack Vector
            </h4>
            <Item className="mb-2">
              <AttackVectorPie data={CVEsToUse} />
            </Item>
            <h4 className="text-lg text-[#F36200] font-semibold text-center font-mono">
              CWE Categories
            </h4>
            <Item>
              <CWECategoryTreemap data={CVEsToUse} />
            </Item>
          </Grid>
          <Grid item xs={4}>
            <h4 className="text-lg text-[#F36200] font-semibold text-center font-mono">
              Impact Metrics
            </h4>
            <Item className="mb-1">
              <CVSSImpactRadar data={CVEsToUse} />
            </Item>
            <Item>
              <CVSSExploitabilityRadar data={CVEsToUse} />
            </Item>
          </Grid>

          <Grid item xs={3}>
            <h4 className="text-lg text-[#F36200] font-semibold text-center font-mono">
              Base Scores
            </h4>
            <Item className="mb-1">
              <BaseScoreBar data={CVEsToUse} />
            </Item>
            <Item className="mb-1">
              <ExploitabilityScoreBar data={CVEsToUse} />
            </Item>
            <Item>
              <ImpactScoreBar data={CVEsToUse} />
            </Item>
          </Grid>
        </Grid>

        <div>
          <input
            type="text"
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
          />
          <button onClick={handlePrediction}>Get Prediction</button>
          {prediction.length > 0 && (
            <div>
              <p>Predictions:</p>
              <ul>
                {prediction.map((label, index) => (
                  <li key={index}>{label}</li>
                ))}
              </ul>
            </div>
          )}
        </div>
      </Box>
    </main>
  );
};

export default Visualizer;
