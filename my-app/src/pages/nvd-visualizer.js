import { useEffect, useState } from "react";
import dynamic from "next/dynamic";
import "../app/globals.css";
import { styled, useTheme } from "@mui/material/styles";
import data from "../data/nvd.json";
import Tabs from "@mui/material/Tabs";
import Tab from "@mui/material/Tab";
import Box from "@mui/material/Box";
import Grid from "@mui/material/Grid";
import Paper from "@mui/material/Paper";
import OutlinedInput from "@mui/material/OutlinedInput";
import InputLabel from "@mui/material/InputLabel";
import MenuItem from "@mui/material/MenuItem";
import FormControl from "@mui/material/FormControl";
import Select from "@mui/material/Select";

const BaseScoreBar = dynamic(() => import("@/components/charts/BaseScoreBar"), {
  ssr: false,
});

const ExploitabilityScoreBar = dynamic(
  () => import("@/components/charts/ExploitabilityScoreBar"),
  {
    ssr: false,
  }
);

const ImpactScoreBar = dynamic(
  () => import("@/components/charts/ImpactScoreBar"),
  {
    ssr: false,
  }
);

const CVSSImpactRadar = dynamic(
  () => import("@/components/charts/CVSSImpactRadar"),
  {
    ssr: false,
  }
);

const CVSSExploitabilityRadar = dynamic(
  () => import("@/components/charts/CVSSExploitabilityRadar"),
  {
    ssr: false,
  }
);

const AttackVectorPie = dynamic(
  () => import("@/components/charts/AttackVectorPie"),
  {
    ssr: false,
  }
);

const CWECategoryTreemap = dynamic(
  () => import("@/components/charts/CWECategoryTreemap"),
  {
    ssr: false,
  }
);

const ParallelCoordinates = dynamic(
  () => import("@/components/charts/ParallelCoordinates"),
  {
    ssr: false,
  }
);

const ITEM_HEIGHT = 48;
const ITEM_PADDING_TOP = 8;
const MenuProps = {
  PaperProps: {
    style: {
      maxHeight: ITEM_HEIGHT * 4.5 + ITEM_PADDING_TOP,
      width: 750,
    },
  },
};

const names = [
  "CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
  "CWE-352:	Cross-Site Request Forgery (CSRF)",
  "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
  "CWE-120: Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')",
  "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer",
  "CWE-787: Out-of-bounds Write",
];

const formatCWELabel = (cwe) => {
  const cweNumber = parseInt(cwe.replace(/\D/g, ""), 10);
  return `CWE-${cweNumber}: ${cweLabels[cweNumber] || "Unknown"}`;
};

const cweLabels = {
  79: "Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
  352: "Cross-Site Request Forgery (CSRF)",
  89: "Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
  120: "Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')",
  119: "Improper Restriction of Operations within the Bounds of a Memory Buffer",
  787: "Out-of-bounds Write",
};

function getStyles(name, CVEsCategory, theme) {
  return {
    fontWeight:
    CVEsCategory.indexOf(name) === -1
        ? theme.typography.fontWeightRegular
        : theme.typography.fontWeightMedium,
  };
}

function TabPanel({ value, index, children }) {
  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`tabpanel-${index}`}
      aria-labelledby={`tab-${index}`}
    >
      {value === index && (
        <Box sx={{ p: 3 }}>
          <h1>{children}</h1>
        </Box>
      )}
    </div>
  );
}

const Item = styled(Paper)(({ theme }) => ({
  backgroundColor: theme.palette.mode === "dark" ? "#1A2027" : "#fff",
  ...theme.typography.body2,
  padding: theme.spacing(1),
  textAlign: "center",
  color: theme.palette.text.secondary,
}));

const Visualizer = () => {
  const theme = useTheme();
  const [value, setValue] = useState("one");
  const [CVEsCategory, setCVEsCategory] = useState([]);
  const [CVEs, setCVEs] = useState([]);

  const handleChange = (event, newValue) => {
    setValue(newValue);
  };

  const handleChangeCWE = (event) => {
    const {
      target: { value },
    } = event;

    if (value.includes("none")) {
      setCVEsCategory([]);
      setCVEs(data);
      return;
    }

    const filteredData = data.filter((entry) => {
      const trimmedCWEs = entry.CWEs.trim();
      if (trimmedCWEs !== "") {
        const cweMatches = trimmedCWEs.match(/\d+/g);
        const cweNumbers = cweMatches ? cweMatches.map(Number) : [];
        return cweNumbers.some((cwe) => value.includes(`${cwe}`));
      }
      return false;
    });

    console.log("Filtered Data:", filteredData);
    setCVEsCategory(value);
    setCVEs(filteredData);
  };

  const CVEsToUse = CVEs.length > 0 ? CVEs : data;

  console.log(data);
  console.log(CVEs);

  return (
    <main className="flex min-h-screen flex-col items-center justify-between p-10">
      <h3 className="text-xl font-semibold text-center font-mono">
        NVD Visualizer
      </h3>
      <Box sx={{ width: "100%" }}>
        <Tabs
          value={value}
          onChange={handleChange}
          textColor="secondary"
          indicatorColor="secondary"
          aria-label="secondary tabs example"
        >
          <Tab
            value="one"
            label="Prediction"
            style={{ textTransform: "none" }}
          />
          <Tab
            value="two"
            label="NVD Visualizations"
            style={{ textTransform: "none" }}
          />
        </Tabs>
        <TabPanel value={value} index="one"></TabPanel>

        <TabPanel value={value} index="two">
          <FormControl className="" sx={{ m: 2, width: 700 }}>
            <InputLabel id="multiple-name-label">CWE Category</InputLabel>
            <Select
              labelId="multiple-name-label"
              id="multiple-name"
              multiple
              value={CVEsCategory}
              onChange={handleChangeCWE}
              input={<OutlinedInput label="CWE Category" />}
              MenuProps={MenuProps}
            >
              <MenuItem
                value="none"
                style={getStyles("none", CVEsCategory, theme)}
              >
                None
              </MenuItem>
              {names.map((name) => (
                <MenuItem
                  key={name}
                  value={name.match(/\d+/)[0]}
                  style={getStyles(name, CVEsCategory, theme)}
                >
                  {formatCWELabel(name)}
                </MenuItem>
              ))}
            </Select>
          </FormControl>

          <Grid container spacing={1}>
            <Grid item xs>
              <h4 className="text-lg font-semibold text-center font-mono">
                Attack Vector
              </h4>
              <Item className="mb-2">
                <AttackVectorPie data={CVEsToUse} />
              </Item>
              <h4 className="text-lg font-semibold text-center font-mono">
                CWE Categories
              </h4>
              <Item>
                <CWECategoryTreemap data={CVEsToUse} />
              </Item>
            </Grid>
            <Grid item xs={4}>
              <h4 className="text-lg font-semibold text-center font-mono">
                Impact Metrics
              </h4>
              <Item className="mb-1">
                <CVSSImpactRadar data={CVEsToUse} />
              </Item>
              <Item>
                <CVSSExploitabilityRadar data={CVEsToUse} />
              </Item>
            </Grid>

            <Grid item xs={3}>
              <h4 className="text-lg font-semibold text-center font-mono">
                Base Scores
              </h4>
              <Item className="mb-1">
                <BaseScoreBar data={CVEsToUse} />
              </Item>
              <Item className="mb-1">
                <ExploitabilityScoreBar data={CVEsToUse} />
              </Item>
              <Item>
                <ImpactScoreBar data={CVEsToUse} />
              </Item>
            </Grid>
          </Grid>
        </TabPanel>
      </Box>
      <div className="mb-32 grid text-center lg:max-w-5xl lg:w-full lg:mb-0 lg:grid-cols-4 lg:text-left"></div>
    </main>
  );
};

export default Visualizer;
